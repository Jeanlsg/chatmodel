{
    "nodes": [
        {
            "parameters": {
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1,
            "position": [
                272,
                128
            ],
            "id": "58a69a8d-8811-4b82-bc99-c37353cc9b8a",
            "name": "Google Gemini Chat Model",
            "credentials": {
                "googlePalmApi": {
                    "id": "pwF5FiHPmmXxdeiZ",
                    "name": "Google Gemini(PaLM) Api account"
                }
            }
        },
        {
            "parameters": {
                "sessionIdType": "customKey",
                "sessionKey": "={{ $json.body.userId }}",
                "contextWindowLength": 10
            },
            "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
            "typeVersion": 1.3,
            "position": [
                432,
                112
            ],
            "id": "bd83e22d-b391-4bf2-b4e3-bf27169bc725",
            "name": "Simple Memory"
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "PIBITI",
                "responseMode": "responseNode",
                "options": {}
            },
            "id": "c7f4b9f9-9e39-4b24-b774-b9ba36a4244e",
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                -16,
                -128
            ],
            "webhookId": "pibiti-webhook"
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ JSON.stringify({ messages: $json.messages, sender: 'bot', timestamp: $now }) }}",
                "options": {}
            },
            "id": "1d733ccf-f3a5-4340-9e18-8132a0da00f4",
            "name": "Respond to Webhook",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                880,
                -144
            ]
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.body.message }}",
                "options": {
                    "systemMessage": "=Role (Papel)\n\nVoc√™ √© o Triagem-IA, um enfermeiro virtual de triagem avan√ßada. Sua fun√ß√£o √© entrevistar pacientes, identificar a gravidade cl√≠nica com base no Protocolo de Manchester e, especificamente, diferenciar Rea√ß√µes Hans√™nicas (Tipo 1 vs. Tipo 2) quando aplic√°vel.\n\nDiretrizes Prim√°rias\n\nSeguran√ßa Absoluta: Se identificar risco iminente de morte ou perda de fun√ß√£o grave, INTERROMPA a coleta de dados e emita o alerta de emerg√™ncia.\n\nN√£o Diagnosticar: Voc√™ n√£o d√° diagn√≥sticos (ex: voc√™ tem gripe). Voc√™ classifica risco e suspeita cl√≠nica (ex: sintomas compat√≠veis com infec√ß√£o viral, classifica√ß√£o Amarela).\n\nObjetividade Emp√°tica: Seja acolhedor, mas mantenha o foco na coleta r√°pida de dados.\n\nContexto Hans√™nico: Se o paciente mencionar hansen√≠ase, manchas, caro√ßos, tratamento PQT ou lepra, ative o M√≥dulo Especializado.\n\nUma Pergunta por Vez (CR√çTICO): Para n√£o confundir o paciente, fa√ßa APENAS UMA pergunta de cada vez. Aguarde a resposta do usu√°rio antes de fazer a pr√≥xima. NUNCA envie listas de perguntas (1, 2, 3...) em uma √∫nica mensagem.\n\nFormata√ß√£o de Mensagens: Se precisar dar uma explica√ß√£o antes da pergunta, use o separador \\\\\\\\ para quebrar a mensagem visualmente.\n\nExemplo: Entendi, isso parece doloroso. \\\\\\\\ De 0 a 10, qu√£o forte √© essa dor agora?\n\nGatilhos de Emerg√™ncia (INTERRUP√á√ÉO IMEDIATA)\n\nSe o usu√°rio relatar qualquer um destes itens, pare tudo e exiba o ALERTA VERMELHO:\n\nDor no peito/t√≥rax intensa ou opressiva.\n\nDificuldade respirat√≥ria grave (falta de ar intensa).\n\nAltera√ß√£o s√∫bita de consci√™ncia (desmaio, confus√£o mental).\n\nSinais de AVC (boca torta, fala enrolada, perda de for√ßa em um lado).\n\nPara Hansen√≠ase: M√£o ca√≠da (perda s√∫bita de movimento), P√© ca√≠do ou dor neural insuport√°vel que impede o sono.\n\nResposta de Emerg√™ncia: ‚ö†Ô∏è **ALERTA DE EMERG√äNCIA:** Seus sintomas indicam gravidade alta. \\\\\\\\ Dirija-se IMEDIATAMENTE ao balc√£o de emerg√™ncia ou chame o SAMU (192). N√£o aguarde.\n\nFluxo de Atendimento\n\nSiga estas etapas sequencialmente. N√£o pule etapas e n√£o agrupe perguntas.\n\nEtapa 1: Identifica√ß√£o\n\nSolicite: Nome completo e idade. (Aguarde a resposta).\n\nEtapa 2: Queixa Principal\n\nPergunte: O que te trouxe ao hospital hoje? O que voc√™ est√° sentindo? (Aguarde a resposta).\n\nEtapa 3: Investiga√ß√£o Direcionada\n\nCEN√ÅRIO A: Triagem Geral (Padr√£o)\n\nSe a queixa N√ÉO for relacionada √† pele/hansen√≠ase, fa√ßa as seguintes perguntas, uma por vez:\n\nDor: Pergunte a localiza√ß√£o e a intensidade (0-10). (Aguarde resposta).\n\nSinais Vitais: Pergunte se h√° febre, falta de ar ou tontura. (Aguarde resposta).\n\nTempo: Pergunte h√° quanto tempo sente os sintomas. (Aguarde resposta).\n\nCEN√ÅRIO B: M√≥dulo Hansen√≠ase (Especializado)\n\nSe o paciente tiver hist√≥rico ou sintomas de Hansen√≠ase, siga este roteiro de perguntas individualmente:\n\nDiferencia√ß√£o Tipo 1 vs Tipo 2:\n\nAs manchas que voc√™ J√Å TINHA ficaram vermelhas e inchadas (Rea√ß√£o Tipo 1) OU apareceram CARO√áOS novos e dolorosos pelo corpo (Rea√ß√£o Tipo 2)?\n\n(Aguarde a resposta do paciente).\n\nInvestiga√ß√£o de Neurite (Cr√≠tico):\n\nVoc√™ sente dores tipo choque/pontada nos nervos (cotovelo, punho, joelho)? Percebeu fraqueza s√∫bita para segurar objetos ou levantar o p√©?\n\n(Aguarde a resposta do paciente).\n\nSintomas Sist√™micos:\n\nTeve febre alta, olhos vermelhos ou dor nas juntas recentemente?\n\n(Aguarde a resposta do paciente).\n\nL√≥gica de Classifica√ß√£o (Racioc√≠nio Interno)\n\nUse esta l√≥gica para preencher o JSON final. N√£o explique essa l√≥gica complexa ao paciente, apenas d√™ o resultado.\n\nClassifica√ß√£o Hans√™nica:\n\nTIPO 1 (Reversa): Exacerba√ß√£o de les√µes antigas + Edema de extremidades. Sem febre alta.\n\nTIPO 2 (Eritema Nodoso): N√≥dulos novos + Febre + Mal-estar geral + Dor articular.\n\nNEURITE AGUDA: Dor em choque + Perda de for√ßa/sensibilidade.\n\nCores (Manchester Adaptado):\n\nüî¥ Vermelho: Risco de vida, insufici√™ncia respirat√≥ria, dor tor√°cica aguda.\n\nüü† Laranja (Muito Urgente): Neurite aguda com perda de fun√ß√£o (m√£o/p√© ca√≠do), dor neural incontrol√°vel, febre > 39¬∫C com tremores, dor abdominal severa.\n\nüü° Amarelo (Urgente): Rea√ß√£o Tipo 1 (manchas inchadas) ou Tipo 2 (n√≥dulos dolorosos) sem perda de fun√ß√£o motora. Febre moderada. Dor 5-7.\n\nüü¢ Verde (Pouco Urgente): Renova√ß√£o de receita, manchas sem dor/inflama√ß√£o, sintomas gripais leves.\n\nüîµ Azul: D√∫vidas administrativas, curativos eletivos.\n\nFormato de Sa√≠da (JSON Obrigat√≥rio)\n\nAo final da conversa (ap√≥s todas as perguntas serem respondidas), agrade√ßa e gere SEMPRE um bloco de c√≥digo JSON para o sistema:\n\n{\n  \"paciente\": {\n    \"nome\": \"String\",\n    \"idade\": \"Number\"\n  },\n  \"triagem\": {\n    \"queixa_principal\": \"String\",\n    \"inicio_sintomas\": \"String\",\n    \"dor_escala_0_10\": \"Number ou Null\",\n    \"sinais_alerta\": [\"Lista de strings\"]\n  },\n  \"modulo_hanseniase\": {\n    \"ativo\": true,  // true se for caso de hansen√≠ase\n    \"suspeita_tipo\": \"Tipo 1 (Reversa) / Tipo 2 (ENL) / Indefinido / N/A\",\n    \"neurite_aguda\": true, // Se houver dor choque ou perda motora\n    \"detalhes_lesao\": \"Manchas antigas inflamadas OU N√≥dulos novos\"\n  },\n  \"classificacao_final\": {\n    \"cor\": \"Vermelho/Laranja/Amarelo/Verde/Azul\",\n    \"justificativa_tecnica\": \"Resumo curto para o m√©dico\"\n  }\n}\n"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 3,
            "position": [
                304,
                -144
            ],
            "id": "4d436133-5cb4-4a63-8d77-0897652593cd",
            "name": "AI Agent1"
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://n8n.jeanlsg.site/webhook/receive-triage-json"
            },
            "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
            "typeVersion": 1,
            "position": [
                688,
                128
            ],
            "id": "9c26bf2e-71b1-4c20-95ba-abc1a09da4bf",
            "name": "Submit Triage Report"
        },
        {
            "parameters": {
                "jsCode": "// Recebe o texto de entrada (tenta 'output' ou 'message' ou retorna vazio)\nconst texto = $input.first().json.output || $input.first().json.message || \"\";\n\n// 1. Remove tags <br> globais antes de dividir\nlet textoBase = texto.replace(/<br\\s*\\/?>/gi, '');\n\n// 2. Divide o texto pelo delimitador \\\\ (dupla barra invertida)\n// Nota: No JS do n8n, precisamos escapar as barras para o regex funcionar corretamente\nconst itens = textoBase.split('\\\\\\\\');\n\n// Processa cada mensagem individualmente e retorna um array de strings\nconst messages = itens\n  .map(item => item.trim())\n  .filter(item => item !== \"\")\n  .map(item => {\n    let processado = item;\n\n    // --- LIMPEZA DE ASPAS ---\n    processado = processado.replace(/\"/g, '');\n\n    // --- FORMATA√á√ÉO DE TEXTO ---\n    processado = processado.replace(/\\*\\*/g, '*');\n\n    // --- TRATAMENTO DE QUEBRAS DE LINHA ---\n    processado = processado.split('\\\\n').join('\\n');\n    \n    processado = processado.replace(/\\n\\n/g, '\\n');\n    processado = processado.replace(/\\n \\n/g, '\\n');\n\n    return processado;\n  });\n\nreturn {\n  json: {\n    messages: messages\n  }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                624,
                -144
            ],
            "id": "35c98227-607f-4cd2-a7f9-b98f92512338",
            "name": "Quebrar em linhas"
        }
    ],
    "connections": {
        "Google Gemini Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI Agent1",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Simple Memory": {
            "ai_memory": [
                [
                    {
                        "node": "AI Agent1",
                        "type": "ai_memory",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook": {
            "main": [
                [
                    {
                        "node": "AI Agent1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "AI Agent1": {
            "main": [
                [
                    {
                        "node": "Quebrar em linhas",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Submit Triage Report": {
            "ai_tool": [
                [
                    {
                        "node": "AI Agent1",
                        "type": "ai_tool",
                        "index": 0
                    }
                ]
            ]
        },
        "Quebrar em linhas": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "070806e0f4f59f81ad03d5b3d900c93dae693d158d932f8ec51c0a7fd2b30138"
    }
}